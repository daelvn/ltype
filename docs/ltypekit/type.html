<!DOCTYPE html>

<html>
<head>
  <title>type.moon</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco-nord.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="init.html">
                  ltypekit/init.moon
                </a>
              
                
                <a class="source" href="sign.html">
                  ltypekit/sign.moon
                </a>
              
                
                <a class="source" href="signature.html">
                  ltypekit/signature.moon
                </a>
              
                
                <a class="source" href="type.html">
                  ltypekit/type.moon
                </a>
              
                
                <a class="source" href="type/Char.html">
                  ltypekit/type/Char.lua
                </a>
              
                
                <a class="source" href="type/Char.html">
                  ltypekit/type/Char.moon
                </a>
              
                
                <a class="source" href="util.html">
                  ltypekit/util.moon
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>type.moon</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">-- ltypekit | 25.11.2018</span>
<span class="hljs-comment">-- By daelvn</span>
<span class="hljs-comment">-- Custom type resolver</span>
<span class="hljs-comment">--   Based on typical and mtype</span>
type_ = <span class="hljs-built_in">type</span>

<span class="hljs-comment">-- Resolvers</span>
<span class="hljs-function"><span class="hljs-title">has_meta</span> = <span class="hljs-params">(val)</span> -&gt;</span>
  val_mt = <span class="hljs-built_in">getmetatable</span> val
  <span class="hljs-keyword">if</span> val_mt
    <span class="hljs-keyword">if</span> (type_ val_mt.__type) == <span class="hljs-string">"function"</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> val_mt.__type val
    <span class="hljs-keyword">else</span>                                        <span class="hljs-keyword">return</span> val_mt.__type
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
<span class="hljs-function"><span class="hljs-title">is_io</span>       = <span class="hljs-params">(val)</span> -&gt;</span> (<span class="hljs-built_in">io</span>.<span class="hljs-built_in">type</span> val) <span class="hljs-keyword">and</span> <span class="hljs-string">"io"</span> <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span>

<span class="hljs-built_in">type</span> = <span class="hljs-built_in">setmetatable</span> {
  <span class="hljs-comment">-- do not add resolvers that work for more types than yours (type_) since</span>
  <span class="hljs-comment">-- it could catch another value which shouldn't.</span>
  <span class="hljs-name">resolvers</span>: {has_meta, is_io} <span class="hljs-comment">-- type_ is not included so that users can add their own before type_</span>
  <span class="hljs-name">types</span>: {
    <span class="hljs-string">"string"</span>, <span class="hljs-string">"number"</span>, <span class="hljs-string">"boolean"</span>, <span class="hljs-string">"userdata"</span>, <span class="hljs-string">"function"</span>, <span class="hljs-string">"table"</span>
    <span class="hljs-string">"io"</span>
    <span class="hljs-string">"signed"</span>, <span class="hljs-string">"signed_constructor"</span>
  }
  <span class="hljs-name">libraries</span>: {}
  <span class="hljs-name">resolve</span>: <span class="hljs-function"><span class="hljs-params">(val, resolvers)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> rname, resolver <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span> resolvers
      val_type = resolver val
      <span class="hljs-keyword">if</span> val_type <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> val_type
    val_type = type_ val
    <span class="hljs-keyword">return</span> val_type <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span>

  <span class="hljs-name">add_resolver</span>: <span class="hljs-function"><span class="hljs-params">(resolver)</span>        =&gt;</span> <span class="hljs-built_in">table</span>.insert @resolvers, resolver
  <span class="hljs-name">add_allowed</span>:  <span class="hljs-function"><span class="hljs-params">(allowed)</span>         =&gt;</span> <span class="hljs-built_in">table</span>.insert @types,     allowed
  <span class="hljs-name">add_types</span>:    <span class="hljs-function"><span class="hljs-params">(typel, resolver)</span> =&gt;</span>
    <span class="hljs-built_in">table</span>.insert @resolvers, resolver
    <span class="hljs-keyword">for</span> allowed <span class="hljs-keyword">in</span> *typel <span class="hljs-keyword">do</span> <span class="hljs-built_in">table</span>.insert @types, allowed
  <span class="hljs-name">add</span>:          <span class="hljs-function"><span class="hljs-params">(xtype, resolver)</span> =&gt;</span>
    <span class="hljs-built_in">table</span>.insert @resolvers, resolver
    <span class="hljs-built_in">table</span>.insert @types,     xtype

  <span class="hljs-name">export</span>: <span class="hljs-function"><span class="hljs-params">(xtype, resolver)</span> =&gt;</span> {:resolver, <span class="hljs-name">type</span>: xtype, <span class="hljs-name">lib</span>: (libraries[xtype] <span class="hljs-keyword">or</span> {})}
  <span class="hljs-name">import</span>: <span class="hljs-function"><span class="hljs-params">(exported)</span> =&gt;</span>
    <span class="hljs-built_in">table</span>.insert @resolvers, exported.resolver
    <span class="hljs-built_in">table</span>.insert @types,     exported.<span class="hljs-built_in">type</span>

  <span class="hljs-name">set_library</span>: <span class="hljs-function"><span class="hljs-params">(xtype, lib)</span> =&gt;</span> @libraries[xtype] = lib
  <span class="hljs-name">libfor</span>:      <span class="hljs-function"><span class="hljs-params">(xtype)</span>      =&gt;</span> @libraries[xtype]

  <span class="hljs-name">resolves</span>: <span class="hljs-function"><span class="hljs-params">(xtype)</span> =&gt;</span>
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> *@types <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> xtype == t <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-literal">false</span>
}, {
  <span class="hljs-name">__call</span>: <span class="hljs-function"><span class="hljs-params">(val)</span> =&gt;</span> @.resolve val, @resolvers
}
typeof = <span class="hljs-built_in">type</span>

<span class="hljs-comment">-- Checks that all values in the list are of the same type. If so, returns the type name, otherwise false.</span>
<span class="hljs-function"><span class="hljs-title">typeforall</span> = <span class="hljs-params">(t)</span> -&gt;</span>
  name   = <span class="hljs-built_in">type</span> t[<span class="hljs-number">1</span>]
  status = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> *t[<span class="hljs-number">2</span>,]
    <span class="hljs-keyword">if</span> (typeof value) != name
      status = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">break</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> status <span class="hljs-keyword">then</span> name <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">libfor</span> = <span class="hljs-params">(xtype)</span> -&gt;</span> typeof\libfor xtype

<span class="hljs-keyword">return</span> { :<span class="hljs-built_in">type</span>, :typeof, :typeforall, :libfor }</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
