<!DOCTYPE html>

<html>
<head>
  <title>sign.moon</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco-nord.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="init.html">
                  ltypekit/init.lua
                </a>
              
                
                <a class="source" href="init.html">
                  ltypekit/init.moon
                </a>
              
                
                <a class="source" href="sign.html">
                  ltypekit/sign.lua
                </a>
              
                
                <a class="source" href="sign.html">
                  ltypekit/sign.moon
                </a>
              
                
                <a class="source" href="signature.html">
                  ltypekit/signature.lua
                </a>
              
                
                <a class="source" href="signature.html">
                  ltypekit/signature.moon
                </a>
              
                
                <a class="source" href="type.html">
                  ltypekit/type.lua
                </a>
              
                
                <a class="source" href="type.html">
                  ltypekit/type.moon
                </a>
              
                
                <a class="source" href="type/Char.html">
                  ltypekit/type/Char.lua
                </a>
              
                
                <a class="source" href="type/Char.html">
                  ltypekit/type/Char.moon
                </a>
              
                
                <a class="source" href="util.html">
                  ltypekit/util.lua
                </a>
              
                
                <a class="source" href="util.html">
                  ltypekit/util.moon
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>sign.moon</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">-- ltypekit | 19.12.2018</span>
<span class="hljs-comment">-- By daelvn</span>
<span class="hljs-comment">-- Signed functions as a unified type</span>
<span class="hljs-comment">-- Added generic support</span>
<span class="hljs-keyword">import</span> binarize, compare   <span class="hljs-keyword">from</span> <span class="hljs-built_in">require</span> <span class="hljs-string">"ltypekit.signature"</span>
<span class="hljs-keyword">import</span> <span class="hljs-built_in">type</span>                <span class="hljs-keyword">from</span> <span class="hljs-built_in">require</span> <span class="hljs-string">"ltypekit.type"</span>
<span class="hljs-keyword">import</span> warn, die, contains <span class="hljs-keyword">from</span> <span class="hljs-built_in">require</span> <span class="hljs-string">"ltypekit.util"</span>

<span class="hljs-keyword">local</span> sign
<span class="hljs-function">
<span class="hljs-title">apply_arguments</span> = <span class="hljs-params">(argl)</span> =&gt;</span>
  SIG = {<span class="hljs-name">signature</span>: @_signature}
  
  parameters = {}

  warn_ = warn
<span class="hljs-function">  <span class="hljs-title">warn</span>  = <span class="hljs-params">(s)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> @safe       <span class="hljs-keyword">then</span> die SIG, s
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @silent <span class="hljs-keyword">then</span> warn_ s

  argn  = #@_tree.<span class="hljs-keyword">in</span>
  <span class="hljs-keyword">if</span> #argl &gt; argn
    warn <span class="hljs-string">"There are more arguments than specified in the signature. Expected <span class="hljs-subst">#{argn}</span>, got <span class="hljs-subst">#{#argl}</span>"</span>
  
  <span class="hljs-comment">-- Collect input</span>
  arg_i = {}
  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>, argn
    matchable = ((@._type @_tree.<span class="hljs-keyword">in</span>[i]) == <span class="hljs-string">"string"</span>) <span class="hljs-keyword">and</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">if</span> matchable <span class="hljs-keyword">and</span> @_tree.<span class="hljs-keyword">in</span>[i]\match <span class="hljs-string">"%-&gt;"</span>
      <span class="hljs-comment">-- Requests a signed function</span>
      <span class="hljs-keyword">if</span> (@._type argl[i]) == <span class="hljs-string">"signed"</span>
        <span class="hljs-keyword">if</span> argl[i]._signature == @_tree.<span class="hljs-keyword">in</span>[i]
          <span class="hljs-built_in">table</span>.insert arg_i, argl[i]
        <span class="hljs-keyword">else</span>
          <span class="hljs-comment">-- Do a rcompare, for it could have *, ! or another generic</span>
          <span class="hljs-keyword">if</span> compare argl[i]._signature, @_tree.<span class="hljs-keyword">in</span>[i], @safe, @silent
            <span class="hljs-built_in">table</span>.insert arg_i, argl[i]
          <span class="hljs-keyword">else</span>
            die SIG, <span class="hljs-string">"Wrong type for argument #<span class="hljs-subst">#{i}</span>. Expected (<span class="hljs-subst">#{@_tree.<span class="hljs-keyword">in</span>[i]}</span>), got (<span class="hljs-subst">#{argl[i]._signature}</span>)"</span>
      <span class="hljs-keyword">else</span>
        die SIG, <span class="hljs-string">"Wrong type for argument #<span class="hljs-subst">#{i}</span>. Expected a signed function, got <span class="hljs-subst">#{@._type argl[i]}</span>"</span>
    <span class="hljs-keyword">elseif</span> matchable <span class="hljs-keyword">and</span> @_tree.<span class="hljs-keyword">in</span>[i]\match <span class="hljs-string">"%*"</span>
      <span class="hljs-comment">-- Any type</span>
      <span class="hljs-built_in">table</span>.insert arg_i, argl[i]
    <span class="hljs-keyword">elseif</span> matchable <span class="hljs-keyword">and</span> @_tree.<span class="hljs-keyword">in</span>[i]\match <span class="hljs-string">"%!"</span>
      <span class="hljs-comment">-- Any type but nil</span>
      <span class="hljs-keyword">if</span> argl[i] != <span class="hljs-literal">nil</span>
        arg_i, argl[i]
      <span class="hljs-keyword">else</span>
        die SIG, <span class="hljs-string">"Wrong type for argument #<span class="hljs-subst">#{i}</span>. Expected any value, got nil."</span>
    <span class="hljs-keyword">elseif</span> contains @_type.types, @_tree.<span class="hljs-keyword">in</span>[i]
      <span class="hljs-comment">-- Simple types</span>
      <span class="hljs-keyword">if</span> (@._type argl[i]) == @_tree.<span class="hljs-keyword">in</span>[i]
        <span class="hljs-built_in">table</span>.insert arg_i, argl[i]
      <span class="hljs-keyword">else</span>
        die SIG, <span class="hljs-string">"Wrong type for argument #<span class="hljs-subst">#{i}</span>. Expected <span class="hljs-subst">#{@_tree.<span class="hljs-keyword">in</span>[i]}</span>, got <span class="hljs-subst">#{@._type argl[i]}</span>"</span>
    <span class="hljs-keyword">elseif</span> ((@._type @_tree.<span class="hljs-keyword">in</span>[i]) == <span class="hljs-string">"table"</span>) <span class="hljs-keyword">and</span> (@_tree.<span class="hljs-keyword">in</span>[i][<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>)
      <span class="hljs-comment">-- Union</span>
      didset = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">for</span> type_ <span class="hljs-keyword">in</span> *@_tree.<span class="hljs-keyword">in</span>[i][<span class="hljs-number">2</span>,]
        <span class="hljs-keyword">if</span> (@._type argl[i]) == type_ <span class="hljs-keyword">then</span> didset = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">if</span> didset
        <span class="hljs-built_in">table</span>.insert arg_i, argl[i]
      <span class="hljs-keyword">else</span>
        die SIG, <span class="hljs-string">"Wrong type for argument #<span class="hljs-subst">#{i}</span>. Expected matching type in union, got <span class="hljs-subst">#{@._type argl[i]}</span>"</span>
    <span class="hljs-keyword">elseif</span> ((@._type @_tree.<span class="hljs-keyword">in</span>[i]) == <span class="hljs-string">"table"</span>) <span class="hljs-keyword">and</span> (@_tree.<span class="hljs-keyword">in</span>[i][<span class="hljs-number">1</span>] == <span class="hljs-number">1</span>)
      <span class="hljs-comment">-- Generic</span>
      <span class="hljs-keyword">if</span> parameters[@_tree.<span class="hljs-keyword">in</span>[i][<span class="hljs-number">2</span>]]
        didset = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">for</span> type_ <span class="hljs-keyword">in</span> *parameters[@_tree.<span class="hljs-keyword">in</span>[i][<span class="hljs-number">2</span>]][<span class="hljs-number">3</span>,]
          <span class="hljs-keyword">if</span> (@._type argl[i]) == type_ <span class="hljs-keyword">then</span> didset = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> didset
          <span class="hljs-built_in">table</span>.insert arg_i, argl[i]
        <span class="hljs-keyword">else</span>
          die SIG, <span class="hljs-string">"Wrong type for argument #<span class="hljs-subst">#{i}</span>. Expected matching type in generic, got <span class="hljs-subst">#{@._type argl[i]}</span>"</span>
      <span class="hljs-keyword">else</span>
        parameters[@_tree.<span class="hljs-keyword">in</span>[i][<span class="hljs-number">2</span>]] = @_tree.<span class="hljs-keyword">in</span>[i]
        didset                 = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">for</span> type_ <span class="hljs-keyword">in</span> *parameters[@_tree.<span class="hljs-keyword">in</span>[i][<span class="hljs-number">2</span>]][<span class="hljs-number">3</span>,]
          <span class="hljs-keyword">if</span> (@._type argl[i]) == type_ <span class="hljs-keyword">then</span> didset = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> didset
          <span class="hljs-built_in">table</span>.insert arg_i, argl[i]
        <span class="hljs-keyword">else</span>
          die SIG, <span class="hljs-string">"Wrong type for argument #<span class="hljs-subst">#{i}</span>. Expected matching type in generic, got <span class="hljs-subst">#{@._type argl[i]}</span>"</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-comment">-- Parameter</span>
      <span class="hljs-keyword">if</span> parameters[@_tree.<span class="hljs-keyword">in</span>[i]]
        <span class="hljs-keyword">if</span> (parameters[@_tree.<span class="hljs-keyword">in</span>[i]] == @._type argl[i])
          <span class="hljs-built_in">table</span>.insert arg_i, argl[i]
        <span class="hljs-keyword">else</span>
          die SIG, <span class="hljs-string">"Wrong type for argument #<span class="hljs-subst">#{i}</span>. Expected <span class="hljs-subst">#{parameters[@_tree.<span class="hljs-keyword">in</span>[i]]}</span>, got <span class="hljs-subst">#{@._type argl[i]}</span>"</span>
      <span class="hljs-keyword">else</span>
        parameters[@_tree.<span class="hljs-keyword">in</span>[i]] = @._type argl[i]
        <span class="hljs-built_in">table</span>.insert arg_i, argl[i]

  <span class="hljs-comment">-- Call function</span>
  arg_m = {@._function (<span class="hljs-built_in">unpack</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">unpack</span>) arg_i}
  <span class="hljs-comment">-- Collect output</span>
  argn  = #@_tree.out
  arg_o = {}

  <span class="hljs-keyword">for</span> i=<span class="hljs-number">1</span>, argn
    matchable = ((@._type @_tree.out[i]) == <span class="hljs-string">"string"</span>) <span class="hljs-keyword">and</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">or</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">if</span> matchable <span class="hljs-keyword">and</span> @_tree.out[i]\match <span class="hljs-string">"%-&gt;"</span>
      <span class="hljs-comment">-- Requests a signed function</span>
      <span class="hljs-keyword">if</span> (@._type arg_m[i]) == <span class="hljs-string">"signed"</span>
        <span class="hljs-keyword">if</span> arg_m[i]._signature == @_tree.out[i]
          <span class="hljs-built_in">table</span>.insert arg_o, arg_m[i]
        <span class="hljs-keyword">else</span>
          <span class="hljs-comment">-- Do a rcompare, for it could have *, ! or another generic</span>
          <span class="hljs-keyword">if</span> compare arg_m[i]._signature, @_tree.out[i], @safe, @silent
            <span class="hljs-built_in">table</span>.insert arg_o, arg_m[i]
          <span class="hljs-keyword">else</span>
            die SIG, <span class="hljs-string">"Wrong type for return value #<span class="hljs-subst">#{i}</span>. Expected (<span class="hljs-subst">#{@_tree.out[i]}</span>), got (<span class="hljs-subst">#{arg_m[i]._signature}</span>)"</span>
      <span class="hljs-keyword">elseif</span> (@._type arg_m[i]) == <span class="hljs-string">"function"</span>
        warn <span class="hljs-string">"Automatically signing right side. This might have unintended side consequences."</span>
        f = (sign @_tree.out[i]) arg_m[i]
        <span class="hljs-built_in">table</span>.insert arg_o, arg_m[i]
      <span class="hljs-keyword">else</span>
        die SIG, <span class="hljs-string">"Wrong type for return value #<span class="hljs-subst">#{i}</span>. Expected a signed function, got <span class="hljs-subst">#{@._type arg_m[i]}</span>"</span>
    <span class="hljs-keyword">elseif</span> matchable <span class="hljs-keyword">and</span> @_tree.out[i]\match <span class="hljs-string">"%*"</span>
      <span class="hljs-comment">-- Any type</span>
      <span class="hljs-built_in">table</span>.insert arg_o, arg_m[i]
    <span class="hljs-keyword">elseif</span> matchable <span class="hljs-keyword">and</span> @_tree.out[i]\match <span class="hljs-string">"%!"</span>
      <span class="hljs-comment">-- Any type but nil</span>
      <span class="hljs-keyword">if</span> arg_m[i] != <span class="hljs-literal">nil</span>
        arg_o, arg_m[i]
      <span class="hljs-keyword">else</span>
        die SIG, <span class="hljs-string">"Wrong type for return value #<span class="hljs-subst">#{i}</span>. Expected any value, got nil."</span>
    <span class="hljs-keyword">elseif</span> contains @_type.types, @_tree.out[i]
      <span class="hljs-comment">-- Simple types</span>
      <span class="hljs-keyword">if</span> (@._type arg_m[i]) == @_tree.out[i]
        <span class="hljs-built_in">table</span>.insert arg_o, arg_m[i]
      <span class="hljs-keyword">else</span>
        die SIG, <span class="hljs-string">"Wrong type for return value #<span class="hljs-subst">#{i}</span>. Expected <span class="hljs-subst">#{@_tree.out[i]}</span>, got <span class="hljs-subst">#{@._type arg_m[i]}</span>"</span>
    <span class="hljs-keyword">elseif</span> ((@._type @_tree.out[i]) == <span class="hljs-string">"table"</span>) <span class="hljs-keyword">and</span> (@_tree.out[i][<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>)
      <span class="hljs-comment">-- Union</span>
      didset = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">for</span> type_ <span class="hljs-keyword">in</span> *@_tree.out[i][<span class="hljs-number">2</span>,]
        <span class="hljs-keyword">if</span> (@._type arg_m[i]) == type_ <span class="hljs-keyword">then</span> didset = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">if</span> didset
        <span class="hljs-built_in">table</span>.insert arg_o, arg_m[i]
      <span class="hljs-keyword">else</span>
        die SIG, <span class="hljs-string">"Wrong type for return value #<span class="hljs-subst">#{i}</span>. Expected matching type in union, got <span class="hljs-subst">#{@._type arg_m[i]}</span>"</span>
    <span class="hljs-keyword">elseif</span> ((@._type @_tree.out[i]) == <span class="hljs-string">"table"</span>) <span class="hljs-keyword">and</span> (@_tree.out[i][<span class="hljs-number">1</span>] == <span class="hljs-number">1</span>)
      <span class="hljs-comment">-- Generic</span>
      <span class="hljs-keyword">if</span> parameters[@_tree.out[i][<span class="hljs-number">2</span>]]
        didset = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">for</span> type_ <span class="hljs-keyword">in</span> *parameters[@_tree.out[i][<span class="hljs-number">2</span>]][<span class="hljs-number">3</span>,]
          <span class="hljs-keyword">if</span> (@._type arg_m[i]) == type_ <span class="hljs-keyword">then</span> didset = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> didset
          <span class="hljs-built_in">table</span>.insert arg_o, arg_m[i]
        <span class="hljs-keyword">else</span>
          die SIG, <span class="hljs-string">"Wrong type for return value #<span class="hljs-subst">#{i}</span>. Expected matching type in generic, got <span class="hljs-subst">#{@._type arg_m[i]}</span>"</span>
      <span class="hljs-keyword">else</span>
        parameters[@_tree.out[i][<span class="hljs-number">2</span>]] = @_tree.out[i]
        didset                 = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">for</span> type_ <span class="hljs-keyword">in</span> *parameters[@_tree.out[i][<span class="hljs-number">2</span>]][<span class="hljs-number">3</span>,]
          <span class="hljs-keyword">if</span> (@._type arg_m[i]) == type_ <span class="hljs-keyword">then</span> didset = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> didset
          <span class="hljs-built_in">table</span>.insert arg_o, arg_m[i]
        <span class="hljs-keyword">else</span>
          die SIG, <span class="hljs-string">"Wrong type for return value #<span class="hljs-subst">#{i}</span>. Expected matching type in generic, got <span class="hljs-subst">#{@._type arg_m[i]}</span>"</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-comment">-- Parameter</span>
      <span class="hljs-keyword">if</span> parameters[@_tree.out[i]]
        <span class="hljs-keyword">if</span> (parameters[@_tree.out[i]] == @._type arg_m[i])
          <span class="hljs-built_in">table</span>.insert arg_o, arg_m[i]
        <span class="hljs-keyword">else</span>
          die SIG, <span class="hljs-string">"Wrong type for return value #<span class="hljs-subst">#{i}</span>. Expected <span class="hljs-subst">#{parameters[@_tree.out[i]]}</span>, got <span class="hljs-subst">#{@._type arg_m[i]}</span>"</span>
      <span class="hljs-keyword">else</span>
        parameters[@_tree.out[i]] = @._type arg_m[i]
        <span class="hljs-built_in">table</span>.insert arg_o, arg_m[i]

  <span class="hljs-keyword">return</span> (<span class="hljs-built_in">unpack</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">unpack</span>) arg_o
<span class="hljs-function">
<span class="hljs-title">sign</span> = <span class="hljs-params">(signature)</span> -&gt;</span> <span class="hljs-built_in">setmetatable</span> {
  <span class="hljs-name">_signature</span>: signature
  <span class="hljs-name">_tree</span>:      binarize signature
  <span class="hljs-name">_type</span>:      <span class="hljs-built_in">type</span>
  <span class="hljs-name">_function</span>:  <span class="hljs-function">-&gt;</span>
  <span class="hljs-name">safe</span>:       <span class="hljs-literal">false</span>
  <span class="hljs-name">silent</span>:     <span class="hljs-literal">true</span>
}, {
  <span class="hljs-name">__type</span>: <span class="hljs-string">"signed_constructor"</span>
  <span class="hljs-name">__add</span>:  <span class="hljs-function"><span class="hljs-params">(resolver)</span> =&gt;</span>
    <span class="hljs-built_in">table</span>.insert @_type.resolvers, resolver
    <span class="hljs-keyword">return</span> @
  <span class="hljs-name">__sub</span>: <span class="hljs-function"><span class="hljs-params">(types)</span> =&gt;</span>
    <span class="hljs-keyword">for</span> type_ <span class="hljs-keyword">in</span> *types <span class="hljs-keyword">do</span> <span class="hljs-built_in">table</span>.insert @_type.types, type_
    <span class="hljs-keyword">return</span> @

  <span class="hljs-comment">-- For type signed*</span>
  <span class="hljs-name">__call</span>: <span class="hljs-function"><span class="hljs-params">(...)</span> =&gt;</span>
    argl = {...}

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">getmetatable</span> @).__type == <span class="hljs-string">"signed_constructor"</span>
      @._function             = argl[<span class="hljs-number">1</span>]
      (<span class="hljs-built_in">getmetatable</span> @).__type = <span class="hljs-string">"signed"</span>
      <span class="hljs-keyword">return</span> @

    <span class="hljs-keyword">return</span> apply_arguments @, argl
}

{ :sign }</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
